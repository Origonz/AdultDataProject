<!DOCTYPE html>
<meta charset="utf-8">
<p id="g1"></p>

<head>
    <style>
        body {
            font-family: "Helvetica Neue", Helvetica, sans-serif;
            font-size: 14px;
        }
    </style>
</head>

<body>

    <script src="https://d3js.org/d3.v4.js"></script>

    <div id="my_dataviz"></div>

    <script>
        var margin = {
            top: 40,
            right: 40,
            bottom: 30,
            left: 50
        };
        width = 900 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        var svg = d3.select("#my_dataviz")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        d3.json("https://raw.githubusercontent.com/Origonz/AdultDataProject/master/data/data.json", function (json) {

            var data_raw = Array.from(Object.values(json))
            var data = []


            data_raw.map(function (d) {
                if (d.duration != 'None')
                    data.push(d)
            })


            data.map(function (d) {
                view = d3.max(d.evolution, function (t) {
                    return +t.views
                })
                d.view = view 
            })


            var x = d3.scaleLinear()
                .range([0, width])
                .nice();

            var y = d3.scaleLinear()
                .range([height, 0]);

            var xAxis = d3.axisBottom(x).ticks(12),
                yAxis = d3.axisLeft(y).ticks(12 * height / width);

            var brush = d3.brush().extent([
                [0, 0],
                [width, height]
            ]).on("end", brushended),
                idleTimeout,
                idleDelay = 350;


            var tooltip = d3.select("#my_dataviz")
                .append("div")
                .style("opacity", 0)
                .attr("class", "tooltip")
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "1px")
                .style("border-radius", "5px")
                .style("padding", "10px")

            var mouseover = function (d) {
                tooltip
                    .style("opacity", 1)
            }

            var mousemove = function (d) {
                tooltip
                    .html("Test")
                    .style("left", (d3.mouse(this)[0] + 90) +
                        "px") // It is important to put the +90: other wise the tooltip is exactly where the point is an it creates a weird effect
                    .style("top", (d3.mouse(this)[1]) + "px")
            }

            var mouseleave = function (d) {
                tooltip
                    .transition()
                    .duration(200)
                    .style("opacity", 0)
            }

            var clip = svg.append("defs").append("svg:clipPath")
                .attr("id", "clip")
                .append("svg:rect")
                .attr("width", width)
                .attr("height", height)
                .attr("x", 0)
                .attr("y", 0);

            var xExtent = d3.extent(data, function (d) {
                return d.duration;
            });

            var yExtent = d3.extent(data, function (d) {
                return d.view;
            });

            x.domain(d3.extent(data, function (d) {

                return d.duration;
            })).nice();
            y.domain(d3.extent(data, function (d) {
                return d.view;
            })).nice();

            var scatter = svg.append("g")
                .attr("id", "scatterplot")
                .attr("clip-path", "url(#clip)");

            scatter.selectAll(".dot")
                .data(data)
                .enter().append("circle")
                .on("click", mouseover)
                .on("mousemove", mousemove)
                .on("mouseleave", mouseleave)
                .attr("class", "dot")
                .attr("r", 4)
                .attr("cx", function (d) {
                    return x(d.duration);
                })
                .attr("cy", function (d) {
                    return y(d.view);
                })
                .attr("opacity", 0.5)
                .style("fill", "#4292c6");


            // x axis
            svg.append("g")
                .attr("class", "x axis")
                .attr('id', "axis--x")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

            svg.append("text")
                .style("text-anchor", "end")
                .attr("x", width)
                .attr("y", height - 8)
                .text("Dur√©e");

            // y axis
            svg.append("g")
                .attr("class", "y axis")
                .attr('id', "axis--y")
                .call(yAxis);

            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", "1em")
                .style("text-anchor", "end")
                .text("Vues");

            scatter.append("g")
                .attr("class", "brush")
                .call(brush);

            function brushended() {

                var s = d3.event.selection;
                if (!s) {
                    if (!idleTimeout) return idleTimeout = setTimeout(idled, idleDelay);
                    x.domain(d3.extent(data, function (d) {
                        return d.duration;
                    })).nice();
                    y.domain(d3.extent(data, function (d) {
                        return d.view;
                    })).nice();
                } else {
                    x.domain([s[0][0], s[1][0]].map(x.invert, x));
                    y.domain([s[1][1], s[0][1]].map(y.invert, y));
                    scatter.select(".brush").call(brush.move, null);
                }
                zoom();
            }

            function idled() {
                idleTimeout = null;
            }

            function zoom() {

                var t = scatter.transition().duration(750);
                svg.select("#axis--x").transition(t).call(xAxis);
                svg.select("#axis--y").transition(t).call(yAxis);
                scatter.selectAll("circle").transition(t)
                    .attr("cx", function (d) {
                        return x(d.duration);
                    })
                    .attr("cy", function (d) {
                        return y(d.view);
                    });
            }

        });
    </script>
</body>