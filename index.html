<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Theme Made By www.w3schools.com - No Copyright -->
  <title>AdultDataProject</title>
  <meta charset="utf-8" />
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <style>
    body {
      font: 20px Montserrat, sans-serif;
      line-height: 1.8;
      color: #080808;
    }

    p {
      font-size: 16px;
    }

    .margin {
      margin-bottom: 45px;
    }

    .bg-1 {
      background-color: #f5f6f7;
      /* Green */
      color: #000000;
    }

    .bg-2 {
      background-color: #474e5d;
      /* Dark Blue */
      color: #ffffff;
    }

    .bg-3 {
      background-color: #ffffff;
      /* White */
      color: #555555;
    }

    .bg-4 {
      background-color: #2f2f2f;
      /* Black Gray */
      color: #fff;
    }

    .container-fluid {
      padding-top: 70px;
      padding-bottom: 70px;
    }

    .navbar {
      padding-top: 15px;
      padding-bottom: 15px;
      border: 0;
      border-radius: 0;
      margin-bottom: 0;
      font-size: 12px;
      letter-spacing: 5px;
    }

    .navbar-nav li a:hover {
      color: #1abc9c !important;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="#home">AdultDataProject</a>
      </div>
      <div class="collapse navbar-collapse" id="myNavbar">
        <ul class="nav navbar-nav navbar-right">
          <li><a href="#category">Category</a></li>
          <li><a href="#views">Views</a></li>
          <li><a href="#days">Days</a></li>
          <li><a href="#cost">Costs</a></li>
          <li><a href="#visu">Visu</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Home -->
  <div class="container-fluid bg-1 text-center" id="home">
    <div class="col-sm-4">
      <p>
        Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do
        eiusmod tempor incididunt ut labore et dolore magna aliqua.
      </p>
    </div>
    <div class="col-sm-8">
      <div id="home_graph"></div>
    </div>
  </div>

  <div class="container-fluid bg-1 text-center" id="category">
    <div class="col-sm-8">
      <div id="category_graph">
		<div id="select-section">
			<select id="d3-debut" >
			  <option value="first">choisissez la date de début</option>
			</select>
			<select id="d3-fin">
			  <option value="last">choisissez la date de fin</option>
			</select>
			<br>
			<label for="cats">Nombre de catégories (1-99):</label>

			<input type="number" id="nb_cats" name="nombre"
			   min="1" max="99" value="15">
		</div>
	  
	  </div>
    </div>
    <div class="col-sm-4">
      <p>
        Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do
        eiusmod tempor incididunt ut labore et dolore magna aliqua.
      </p>
    </div>
  </div>

  <div class="container-fluid bg-1 text-center" id="views">
    <div class="col-sm-4">
      <p>
        Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do
        eiusmod tempor incididunt ut labore et dolore magna aliqua.
      </p>
    </div>
    <div class="col-sm-8">
      <div id="views_graph"></div>
    </div>
  </div>

  <div class="container-fluid bg-1 text-center" id="days">
    <div class="col-sm-8">
      <div id="days_graph"></div>
    </div>
    <div class="col-sm-4">
      <p>
        Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do
        eiusmod tempor incididunt ut labore et dolore magna aliqua.
      </p>
    </div>
  </div>

  <div class="container-fluid bg-1 text-center" id="cost">
    <div class="col-sm-4">
      <p>
        Ce graphe présente les vidéos collectées par rapport à leurs durées en secondes
        et leurs nombres de vues. Ainsi, les vidéos les plus longues représentent un enjeu en terme
        de stockage dans les datacenters et les vidéos les plus vues un enjeu en trafic.

        On peut voir que la majorité des vidéos qui sont stockées dans les datacenters sont très peu vues, 
        il serait intéressant de procéder à un "nettoyage" quand une vidéo est assez longue et 
        ne rencontre pas une certaine popularité, en vu de réduire les consommations énergétiques.
      </p>
    </div>
    <div class="col-sm-8">
      <div id="cost_graph">

        <script>
          var margin = {
            top: 40,
            right: 40,
            bottom: 30,
            left: 150
          };
          width = 900 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

          // append the svg object to the body of the page
          var svg = d3.select("#cost")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");

          d3.json("https://raw.githubusercontent.com/Origonz/AdultDataProject/master/data/data.json", function (json) {

            var data_raw = Array.from(Object.values(json))
            var data = []


            data_raw.map(function (d) {
              if (d.duration != 'None')
                data.push(d)
            })


            data.map(function (d) {
              view = d3.max(d.evolution, function (t) {
                return +t.views
              })
              d.view = view
            })


            var x = d3.scaleLinear()
              .range([0, width])
              .nice();

            var y = d3.scaleLinear()
              .range([height, 0]);

            var xAxis = d3.axisBottom(x).ticks(12),
              yAxis = d3.axisLeft(y).ticks(12 * height / width);

            var brush = d3.brush().extent([
              [0, 0],
              [width, height]
            ]).on("end", brushended),
              idleTimeout,
              idleDelay = 350;


            var tooltip = d3.select("#cost")
              .append("div")
              .style("opacity", 0)
              .attr("class", "tooltip")
              .style("background-color", "white")
              .style("border", "solid")
              .style("border-width", "1px")
              .style("border-radius", "5px")
              .style("padding", "10px")

            var mouseover = function (d) {
              console.log(d)
              console.log("Test")
              tooltip

                .style("opacity", 1)
            }

            var mousemove = function (d) {
              console.log(d)
              console.log("Test")
              tooltip

              /*
              .style("left", (d3.mouse(this)[0] + 90) +
                  "px") // It is important to put the +90: other wise the tooltip is exactly where the point is an it creates a weird effect
              .style("top", (d3.mouse(this)[1]) + "px")
              */
            }

            var mouseleave = function (d) {
              console.log(d)
              console.log("Test")
              tooltip
                .transition()
                .duration(200)
                .style("opacity", 0)
            }

            var clip = svg.append("defs").append("svg:clipPath")
              .attr("id", "clip")
              .append("svg:rect")
              .attr("width", width)
              .attr("height", height)
              .attr("x", 0)
              .attr("y", 0);

            var xExtent = d3.extent(data, function (d) {
              return d.duration;
            });

            var yExtent = d3.extent(data, function (d) {
              return d.view;
            });

            x.domain(d3.extent(data, function (d) {

              return d.duration;
            })).nice();
            y.domain(d3.extent(data, function (d) {
              return d.view;
            })).nice();

            var scatter = svg.append("g")
              .attr("id", "scatterplot")
              .attr("clip-path", "url(#clip)");

            scatter.selectAll(".dot")
              .data(data)
              .enter().append("circle")
              .attr("class", "dot")
              .attr("r", 4)
              .attr("cx", function (d) {
                return x(d.duration);
              })
              .attr("cy", function (d) {
                return y(d.view);
              })
              .attr("opacity", 0.5)
              .style("fill", "#4292c6")
              .style('pointer-events', 'none')
              .on("mousemove", mousemove)
              .on("mouseout", mouseleave)
              .on("mouseover", mouseover);;


            // x axis
            svg.append("g")
              .attr("class", "x axis")
              .attr('id', "axis--x")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis);

            svg.append("text")
              .style("text-anchor", "end")
              .attr("x", width)
              .attr("y", height - 8)
              .text("Durée");

            // y axis
            svg.append("g")
              .attr("class", "y axis")
              .attr('id', "axis--y")
              .call(yAxis);

            svg.append("text")
              .attr("transform", "rotate(-90)")
              .attr("y", 6)
              .attr("dy", "1em")
              .style("text-anchor", "end")
              .text("Vues");

            scatter.append("g")
              .attr("class", "brush")
              .call(brush);


            function brushended() {

              var s = d3.event.selection;
              if (!s) {
                if (!idleTimeout) return idleTimeout = setTimeout(idled, idleDelay);
                x.domain(d3.extent(data, function (d) {
                  return d.duration;
                })).nice();
                y.domain(d3.extent(data, function (d) {
                  return d.view;
                })).nice();
              } else {
                x.domain([s[0][0], s[1][0]].map(x.invert, x));
                y.domain([s[1][1], s[0][1]].map(y.invert, y));
                scatter.select(".brush").call(brush.move, null);
              }
              zoom();
            }

            function idled() {
              idleTimeout = null;
            }

            function zoom() {

              var t = scatter.transition().duration(750);
              svg.select("#axis--x").transition(t).call(xAxis);
              svg.select("#axis--y").transition(t).call(yAxis);
              scatter.selectAll("circle").transition(t)
                .attr("cx", function (d) {
                  return x(d.duration);
                })
                .attr("cy", function (d) {
                  return y(d.view);
                });
            }

          });
		  
		  // ---------------------------------------------------------------------------------------------
		  // SCRIPT CATEGORIES
		  var display_cats = function(begin,finish,nb_display){
			d3.json("https://raw.githubusercontent.com/Origonz/AdultDataProject/master/data/category.json", function(data){
			
			d3.select("#svg_cats").remove();
			var diff  = [];
			var cats = [];
			
			dates = Object.keys(data)
			Object.keys(data[dates[0]]).forEach( cat => cats.push(cat))

			
			var svg = d3.select("#category_graph").append("svg")
			.attr("width", width)
			.attr("height", height)
			.attr("id", "svg_cats")


			svg.append("text")
			.text("Parts des catégories les plus populaires dans la consommation globale")
			.attr("y", height * 0.05)
			.attr("x", width * 0.1)
			.attr("font-size", width * 0.02)
			.attr("font-family", "monospace")

			var data2 = dates.map( 
			  function(key) {
				var dict = {};
				dict["date"] = key
				Object.keys(data[key]).forEach(
				  function(key2) {
					dict[key2] = data[key][key2]
				  }
				)
				return dict;
			  }
			)
			
					
			var total = 0;
			if(begin == false || finish == false || begin == "first" || finish == "last"){
			  diff = cats.map(function(cat){
				var dict = { id: cat,
				  value : data2[data2.length - 1][cat] - data2[0][cat]}
				total += dict.value
				return dict;
			  })
					} else {
			  diff = cats.map(function(cat){
				var dict = { id: cat,
				  value : data[finish][cat] - data[begin][cat]}
				total += dict.value
				return dict;
			  })
			}
        
			var best = [];
			var minVal = 1000000000;
			for(let i = 0; i < cats.length; i++){
			  if (best.length < nb_display){
				best.push(i)

				if (diff[i]["value"] < minVal){
				  minVal = diff[i]["value"]
				}
			  } else {
				if (diff[i]["value"] > minVal){
				  for(let j = 0; j < nb_display; j++){
					if (diff[best[j]].value == minVal){
					  best[j] = i
					  break;
					}
				  }
				  minVal = Number.MAX_VALUE;
				  for(let j = 0; j < nb_display; j++){
					if (diff[best[j]]["value"] < minVal){
					  minVal = diff[best[j]]["value"]
					}
				  }
				}
			  }
			}


			var to_display = diff.filter(function(d,i){
			  for(let j = 0; j < cats.length; j++){
				if (i == best[j]){
				  return true;
				}
			  }
			  return false;
			});

			maxima = 0

			to_display.forEach(function(d){
			  if (d["value"] > maxima){
				maxima = d["value"]
			  }
			})

			function keysrt(key,desc) {
			  return function(a,b){
			   return desc ? ~~(a[key] > b[key]) : ~~(a[key] < b[key]);
			  }
			}
			to_display.sort(keysrt("value"))

			var width_ = d3.scaleLinear()
			.domain([0,maxima])
			.range([width - 150 , 0.05 * width]);
					
			var y = d3.scaleLinear()
			.domain([0,parseInt(nb_display) + 1])
			.range([height * 0.1, height]);

			var xperCent = d3.scaleLinear()
			.domain([0,Math.floor(1 + to_display[0].value/total * 100)])
			.range([150 , width - 20]);

			
			svg.selectAll("rect").data(to_display).enter()
					.append("rect")
					.attr("width", function(d) { 
				return width - (150 + width_(d["value"])); 
			  }).attr("height", (height * 0.8) / (parseInt(nb_display) + 1))
					.attr("x", function(d) { return  150; })
					.attr("y",  function(d,i) { return y(i); })
					.style("fill", function(d){ return "red"})

			d3.json("https://raw.githubusercontent.com/Origonz/AdultDataProject/master/data/cat_userfriendly.json", function(dataAno){

			  svg.selectAll("text25").data(to_display).enter()
			  .append("text")
			  .text(function(d){
				return dataAno[d.id] 
			  })
			  .attr("y", function(d,i){return y(i) + ((height * 0.8) / (nb_display + 1))/2})
			  .attr("x", 10)
			  .attr("font-size", 12)
			  .attr("font-family", "monospace");

			})

			var tab = []
			for(let i = 0; i < 1 + to_display[0].value/total * 100; i++){
			  tab.push(i)
			}

			svg.selectAll("text2").data(tab).enter()
			.append("text")
			.text(function(d){
			  return d + "%"
			})
			.attr("y", height *0.99)
			.attr("x", function(d){return xperCent(d)})
			.attr("font-size", 12)
			.attr("font-family", "monospace");

		    });
		  }
		  
		  d3.json("https://raw.githubusercontent.com/Origonz/AdultDataProject/master/data/category.json", function(data){
      
			  keys = Object.keys(data)
			  keys.forEach( function(key){
				
				var node1 = document.createElement("option");
				var node2 = document.createElement("option");
				
				var textnode1 = document.createTextNode(key);         
				var textnode2 = document.createTextNode(key);         
				// Create a text node
						node1.appendChild(textnode1);
				node2.appendChild(textnode2);
				
						document.getElementById("d3-debut").appendChild(node1)
				
				document.getElementById("d3-fin").appendChild(node2)
			  })
      
		  })
		  
		  d3.select("#select-section").on("change", function(d) {
			  var begin = d3.select("#d3-debut").node().value;
			  var finish = d3.select("#d3-fin").node().value;
			  var nb_cats = d3.select("#nb_cats").node().value;
			  
			  display_cats(begin,finish,nb_cats)
		  })
			
		  display_cats(false,false,d3.select("#nb_cats").node().value)
		  
		  //------------------------------- FIN CATEGORIES --------------------------------------------------
        </script>

      </div>
    </div>
  </div>

  <div class="container-fluid bg-1 text-center" id="visu">
    <div class="col-sm-8">
      <div id="visu_graph"></div>
    </div>
    <div class="col-sm-4">
      <p>
        Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do
        eiusmod tempor incididunt ut labore et dolore magna aliqua.
      </p>
    </div>
  </div>

  <!-- Footer -->
  <footer class="container-fluid bg-4 text-center">
    <p>
      AdultDataProject
    </p>
  </footer>
</body>

</html>